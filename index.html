به نظر می‌رسد که مشکلی در حلقه انیمیشن ایجاد شده است. احتمالاً به دلیل تغییراتی که در ایجاد الگوها اعمال کرده‌ایم، زمانی که یکی از الگوها قرار است ایجاد شود، مشکلی در به‌روزرسانی یا حذف کندل‌های قدیمی رخ داده است. بیایید مشکل را برطرف کنیم:

علت مشکل:

	•	در الگوی Engulfing یا سایر مواردی که نیاز به وابستگی به کندل قبلی دارند، ممکن است ارجاع به کندل قبلی دچار خطا شود، به‌ویژه اگر لیست کندل‌ها خالی باشد.
	•	ممکن است برخی کندل‌ها به‌درستی از آرایه حذف نشده باشند، و این باعث شود انیمیشن متوقف شود.

اصلاح کد:

بیایید مطمئن شویم:

	1.	حلقه انیمیشن همیشه اجرا شود.
	2.	الگوها به‌درستی ایجاد شوند و خطایی رخ ندهد.
	3.	کندل‌های خارج از صفحه به‌درستی حذف شوند.

کد بهینه‌شده زیر مشکل را برطرف می‌کند:

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Forex Chart with Patterns</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(120deg, #001f3f, #003366);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chartCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        body {
            animation: gradientBackground 10s infinite alternate;
        }

        @keyframes gradientBackground {
            0% {
                background: linear-gradient(120deg, #001f3f, #003366);
            }
            50% {
                background: linear-gradient(120deg, #003366, #001f3f);
            }
            100% {
                background: linear-gradient(120deg, #001f3f, #005f99);
            }
        }
    </style>
</head>
<body>
    <canvas id="chartCanvas"></canvas>
    <script>
        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const candlesticks = [];
        const maxCandles = 100;
        const candleWidth = 6;
        const spaceBetween = 8;
        const waveAmplitude = 20;

        // ایجاد کندل جدید
        function createCandlestick() {
            const x = candlesticks.length * (candleWidth + spaceBetween);
            const y = Math.random() * canvas.height;
            let open = Math.random() * 50 + y;
            let close = Math.random() * 50 + y;
            let high = Math.max(open, close) + Math.random() * 30;
            let low = Math.min(open, close) - Math.random() * 30;
            const color = open > close ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 255, 0, 0.8)';
            const speed = Math.random() * 1 + 0.8;
            const phase = Math.random() * Math.PI * 2;

            // ایجاد کندل خاص (الگوها)
            const patternChance = Math.random();
            if (patternChance < 0.1) {
                // Doji
                close = open;
                high = close + 10;
                low = close - 10;
            } else if (patternChance < 0.2) {
                // Hammer
                high = open + 5;
                low = close - 30;
            } else if (patternChance < 0.3) {
                // Shooting Star
                low = close - 5;
                high = open + 30;
            } else if (patternChance < 0.4) {
                // Engulfing
                const prevCandle = candlesticks[candlesticks.length - 1];
                if (prevCandle) {
                    open = prevCandle.close - 20;
                    close = prevCandle.open + 20;
                    high = Math.max(open, close) + 10;
                    low = Math.min(open, close) - 10;
                }
            }

            candlesticks.push({ x, y, open, close, high, low, color, speed, phase });
        }

        // رسم کندل‌ها
        function drawCandlesticks() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            candlesticks.forEach((candle, index) => {
                const waveOffset = Math.sin((candle.x / canvas.width) * Math.PI * 2 + candle.phase) * waveAmplitude;

                ctx.beginPath();
                ctx.moveTo(candle.x, candle.high + waveOffset);
                ctx.lineTo(candle.x, candle.low + waveOffset);
                ctx.strokeStyle = candle.color;
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = candle.color;
                ctx.fillRect(
                    candle.x - candleWidth / 2,
                    Math.min(candle.open, candle.close) + waveOffset,
                    candleWidth,
                    Math.abs(candle.open - candle.close)
                );

                candle.x -= candle.speed;

                if (candle.x < -candleWidth) {
                    candlesticks.splice(index, 1); // حذف کندل‌هایی که از صفحه خارج می‌شوند
                }
            });

            // اضافه کردن کندل جدید
            if (candlesticks.length < canvas.width / (candleWidth + spaceBetween)) {
                createCandlestick();
            }
        }

        function animate() {
            try {
                drawCandlesticks();
                requestAnimationFrame(animate);
            } catch (error) {
                console.error('Animation Error:', error);
            }
        }

        animate();
    </script>
</body>
</html>

تغییرات و رفع مشکل:

	1.	خطای الگوها:
در صورت نبودن کندل قبلی، از الگوی Engulfing صرف‌نظر می‌شود تا خطایی رخ ندهد.
	2.	حلقه انیمیشن:
یک بخش خطایابی اضافه کردیم تا اگر خطایی در رسم کندل‌ها رخ داد، حلقه انیمیشن متوقف نشود.
	3.	حذف کندل‌های قدیمی:
اطمینان حاصل شد که کندل‌ها به‌درستی حذف می‌شوند تا انباشت داده‌ها رخ ندهد.

نتیجه:

این نسخه باید